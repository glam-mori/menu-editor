<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠå“æ›¸ãã‚¨ãƒ‡ã‚£ã‚¿ (screenshotç‰ˆ)</title> 
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ten+Mincho&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆå®šç¾© */
        .font-noto { font-family: 'Noto Serif JP', serif; }
        .font-ten { font-family: 'Ten Mincho', serif; }
        .font-yuji { font-family: 'Yuji Syuku', serif; }

        /* ç”»åƒè¨­å®š */
        .menu-category h2 { position: relative; z-index: 1; }
        .h2-bg-image { position: absolute; left: 0; z-index: -1; opacity: 0.7; }

        /* åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body {
            font-family: ui-sans-serif, system-ui, sans-serif;
            display: flex; flex-direction: column; height: 100vh; margin: 0; padding: 0;
        }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        #preview-wrapper {
            height: 50vh; overflow: auto; background-color: #f0f0f0;
            padding: 2.5rem 0; display: flex; justify-content: center; align-items: flex-start;
        }
        
        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç”¨ç´™éƒ¨åˆ†ï¼‰ */
        #canvas {
            background-color: #ffffff; border: 1px solid #ddd; flex-shrink: 0; 
            overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            /* é‡è¦: ã“ã‚ŒãŒãªã„ã¨ã‚¹ã‚¯ã‚·ãƒ§æ™‚ã«èƒŒæ™¯ãŒé€æ˜ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ */
            background: white; 
        }
        
        #canvas-content { height: 100%; width: 100%; }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #form-wrapper { height: 50vh; overflow: auto; background-color: #f9f9f9; border-top: 2px solid #ddd; }

        /* ãƒ•ã‚©ãƒ¼ãƒ UIã‚¹ã‚¿ã‚¤ãƒ« (çœç•¥ãªã—) */
        .form-input { width: 100%; border: 1px solid #ccc; border-radius: 6px; padding: 8px 12px; }
        .form-select {
             width: 100%; border: 1px solid #ccc; border-radius: 6px; padding: 8px 12px;
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
             -webkit-appearance: none; appearance: none;
        }
        .form-label { font-size: 0.875rem; font-weight: 600; color: #333; display: block; margin-bottom: 0.25rem; }
        .btn { padding: 6px 12px; border-radius: 6px; font-weight: 600; text-align: center; cursor: pointer; border: none; transition: 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-secondary { background-color: #4b5563; color: white; }
        
        .btn-control {
            background-color: #e5e7eb; color: #1f2937; width: 36px; height: 36px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; border-radius: 6px; border: none; cursor: pointer;
        }
        .btn-control:hover { background-color: #d1d5db; }
        .btn-control svg { width: 1.25rem; height: 1.25rem; stroke-width: 2.5; }
        .btn-control-danger { background-color: #fef2f2; color: #dc2626; }
        .btn-control-danger:hover { background-color: #fee2e2; color: #b91c1c; }

        .form-row { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .drag-handle { cursor: move; font-size: 1.25rem; color: #9ca3af; flex-shrink: 0; }
        .form-checkbox { width: 1.25rem; height: 1.25rem; border-radius: 4px; flex-shrink: 0; }
        .form-input-grow { flex-grow: 1; }
        .sortable-ghost { opacity: 0.4; background: #cce7ff; }
        
        .canvas-size-display { font-size: 0.875rem; font-weight: 600; color: #1f2937; width: 4rem; text-align: right; flex-shrink: 0; }
        .font-size-label { font-size: 0.875rem; color: #4b5563; flex-shrink: 0; margin-left: 8px; }
        .font-size-display { font-size: 0.875rem; font-weight: 600; color: #1f2937; width: 3rem; text-align: right; flex-shrink: 0; }
        .line-height-display { font-size: 0.875rem; font-weight: 600; color: #1f2937; width: 3.5rem; text-align: right; margin-right: 4px; flex-shrink: 0; }

        /* å°åˆ·ç”¨CSS: ãƒ–ãƒ©ã‚¦ã‚¶å°åˆ·æ©Ÿèƒ½ã‚’ä½¿ã†å ´åˆã®åˆ¶å¾¡ */
        @media print {
            body * { visibility: hidden; }
            #preview-wrapper, #preview-wrapper * { visibility: visible; }
            #preview-wrapper { 
                position: absolute; left: 0; top: 0; width: 100%; height: auto; 
                background: none; padding: 0; display: block; 
            }
            #canvas { 
                border: none; box-shadow: none; margin: 0 auto; 
                transform: none !important; width: 100% !important; height: auto !important;
            }
            #form-wrapper { display: none; }
        }
    </style>
</head>
<body>

    <div id="preview-wrapper">
        <div id="canvas">
            <div id="canvas-content" class="h-full w-full py-10 px-8 text-gray-800">
                </div>
        </div>
    </div>

    <div id="form-wrapper">
        <div class="p-4" id="form-content-wrapper">
            <div class="mb-4" id="title-form-group">
                <label class="form-label">å¤§è¦‹å‡ºã—</label>
                <div class="form-row">
                    <input type="text" id="form-title" class="form-input form-input-grow">
                    <span class="font-size-label">Size:</span>
                    <span class="font-size-display">18px</span> 
                    <button class="btn btn-control" data-style-op="h1-font-dec"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg></button>
                    <button class="btn btn-control" data-style-op="h1-font-inc"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg></button>
                </div>
            </div>

            <div class="mb-4 p-4 border border-gray-300 rounded-lg bg-white">
                <h3 class="form-label mb-2">å…¨ä½“è¨­å®š</h3>
                <div class="flex flex-wrap gap-x-6 gap-y-4">
                    </div>
            </div>

            <div id="categories-form-list"></div>
            
            <div class="flex gap-4 mt-6">
                <button id="add-category-btn" class="btn btn-primary flex-grow">ï¼‹ ä¸­è¦‹å‡ºã—ã‚’è¿½åŠ </button>
                <button id="delete-selected-btn" class="btn btn-danger">é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤</button>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-300">
                <h3 class="font-bold text-gray-700 mb-2">å‡ºåŠ›ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
                <div class="flex flex-col gap-3">
                    <button id="export-pdf-btn" class="btn btn-primary w-full text-lg py-3">
                        ğŸ“¸ ç”»åƒã‚¹ã‚¯ã‚·ãƒ§æ–¹å¼ã§PDFåŒ– (æ¨å¥¨)
                    </button>
                    
                    <button id="browser-print-btn" class="btn btn-secondary w-full text-sm py-2">
                        ğŸ–¨ï¸ ã†ã¾ãã„ã‹ãªã„å ´åˆã¯ã“ã¡ã‚‰ (ãƒ–ãƒ©ã‚¦ã‚¶å°åˆ·ã§ä¿å­˜)
                    </button>
                </div>
                <div class="text-center text-xs text-gray-500 mt-2">
                    â€»ç”»åƒæ–¹å¼ã¯ç”Ÿæˆã«æ•°ç§’ã‹ã‹ã‚Šã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å°åˆ·ã¯ã€Œé€ä¿¡å…ˆã€ã‚’ã€ŒPDFã«ä¿å­˜ã€ã«ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>

        </div> 
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿åˆæœŸè¨­å®š ---
        let menuData = {
            title: "ã€‡ã€‡æ§˜ç‰¹åˆ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼", 
            titleFontSize: 18,  
            styles: {
                lineHeightH2: 10, lineHeightP: 20, canvasWidth: 91, canvasHeight: 257,
                fontFamily: "'Noto Serif JP', serif" 
            },
            categories: [
                { id: crypto.randomUUID(), name: "å…ˆä»˜", isChecked: false, fontSizeH2: 20, items: [{ id: crypto.randomUUID(), name: "ä¹ã®å‰èœ", isChecked: false, fontSizeP: 16 }] },
                { id: crypto.randomUUID(), name: "ã—ã‚ƒã¶ã—ã‚ƒã¶", isChecked: false, fontSizeH2: 20, items: [
                    { id: crypto.randomUUID(), name: "â– è‚‰", isChecked: false, fontSizeP: 16 },
                    { id: crypto.randomUUID(), name: "å®®å´ç‰›ã‚µãƒ¼ãƒ­ã‚¤ãƒ³", isChecked: false, fontSizeP: 16 },
                    { id: crypto.randomUUID(), name: "é»’æ¯›å’Œç‰›ã‚¿ãƒ³", isChecked: false, fontSizeP: 16 },
                    { id: crypto.randomUUID(), name: "â– é‡èœ", isChecked: false, fontSizeP: 16 },
                    { id: crypto.randomUUID(), name: "ç™½èœ", isChecked: false, fontSizeP: 16 },
                ]},
                { id: crypto.randomUUID(), name: "ç”˜å‘³", isChecked: false, fontSizeH2: 20, items: [{ id: crypto.randomUUID(), name: "æ¶²ä½“çª’ç´ ã‚¢ã‚¤ã‚¹", isChecked: false, fontSizeP: 16 }] }
            ]
        };

        // --- DOMè¦ç´  ---
        const previewWrapper = document.getElementById('preview-wrapper');
        const canvasEl = document.getElementById('canvas');
        const previewContent = document.getElementById('canvas-content');
        const formTitle = document.getElementById('form-title');
        const categoriesFormList = document.getElementById('categories-form-list');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const formContentWrapper = document.getElementById('form-content-wrapper');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const browserPrintBtn = document.getElementById('browser-print-btn');

        // === 1. ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–° ===
        function updateCanvasStyle() {
            const styles = menuData.styles;
            const formFontFamily = document.getElementById('form-font-family');
            if (formFontFamily) { canvasEl.style.fontFamily = formFontFamily.value; } 
            else { canvasEl.style.fontFamily = menuData.styles.fontFamily; }
            
            // ç”»é¢è¡¨ç¤ºç”¨ã®ã‚µã‚¤ã‚ºè¨ˆç®—
            const baseScale = 600 / 210; 
            let widthPx = styles.canvasWidth * baseScale;
            let heightPx = styles.canvasHeight * baseScale;
            
            const availableWidth = previewWrapper.clientWidth * 0.9;
            if (widthPx > availableWidth) {
                const fitScale = availableWidth / widthPx;
                widthPx = widthPx * fitScale;
                heightPx = heightPx * fitScale;
            }
            
            canvasEl.style.width = `${widthPx}px`;
            canvasEl.style.height = `${heightPx}px`;
        }

        // === 2. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”» ===
        function renderPreview() {
            previewContent.innerHTML = ''; 
            
            const h1 = document.createElement('h1');
            h1.className = 'text-3xl font-bold text-center mb-8 tracking-wider';
            h1.textContent = menuData.title;
            h1.style.fontSize = `${menuData.titleFontSize}px`;
            previewContent.appendChild(h1);

            const styles = menuData.styles; 
            
            menuData.categories.forEach((category) => {
                const section = document.createElement('section');
                section.className = 'menu-category mb-6'; 
                section.style.lineHeight = styles.lineHeightP + 'px'; 
                
                const h2 = document.createElement('h2');
                h2.className = 'font-bold mb-3';
                h2.style.position = 'relative'; h2.style.zIndex = '1'; 
                h2.style.color = '#A4252A'; 
                h2.style.fontSize = `${category.fontSizeH2}px`; 
                h2.style.lineHeight = styles.lineHeightH2 + 'px'; 
                
                const bgSize = category.fontSizeH2 * 1.2; 
                h2.style.paddingLeft = `${bgSize + 4}px`; 
                
                let bgTop = (styles.lineHeightH2 - bgSize) / 2;
                bgTop += (category.fontSizeH2 / 2);

                const img = document.createElement('img');
                img.src = '22691375.png'; 
                img.className = 'h2-bg-image'; 
                // ã€é‡è¦ã€‘GitHubç­‰ã§ã®CORSã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŠã¾ã˜ãªã„
                img.crossOrigin = "anonymous"; 
                img.style.width = `${bgSize}px`;
                img.style.height = `${bgSize}px`;
                img.style.top = `${bgTop}px`; 
                h2.appendChild(img);

                const span = document.createElement('span');
                span.textContent = category.name;
                h2.appendChild(span);
                section.appendChild(h2);
                
                category.items.forEach(item => {
                    const p = document.createElement('p');
                    p.textContent = item.name;
                    p.className = 'menu-item pl-8';
                    p.style.fontSize = `${item.fontSizeP}px`; 
                    section.appendChild(p);
                });
                previewContent.appendChild(section);
            });
        }

        // === 3. ãƒ•ã‚©ãƒ¼ãƒ æç”» ===
        function renderForm() {
            const svgMinus = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg>`;
            const svgPlus = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>`;
            const svgTrash = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;

            const globalSettingsDiv = document.querySelector('#form-wrapper .flex.flex-wrap.gap-x-6.gap-y-4');
            if (globalSettingsDiv) {
                globalSettingsDiv.innerHTML = `
                    <div class="flex-shrink-0" style="width: 200px;">
                        <label class="form-label">ãƒ•ã‚©ãƒ³ãƒˆ</label>
                        <div class="flex items-center gap-2 mt-1">
                            <select id="form-font-family" class="form-select">
                                <option value="'Noto Serif JP', serif">Noto Serif JP</option>
                                <option value="'Ten Mincho', serif">è²‚æ˜æœ</option>
                                <option value="'Yuji Syuku', serif">Yuji Syuku (ç­†)</option>
                            </select>
                        </div>
                    </div>
                    <div id="global-style-canvas-w" class="flex-shrink-0"><label class="form-label">ã‚­ãƒ£ãƒ³ãƒã‚¹å¹…</label><div class="flex items-center gap-2 mt-1"><span class="canvas-size-display">... mm</span><button class="btn btn-control" data-style-op="canvas-w-dec">${svgMinus}</button><button class="btn btn-control" data-style-op="canvas-w-inc">${svgPlus}</button></div></div>
                    <div id="global-style-canvas-h" class="flex-shrink-0"><label class="form-label">ã‚­ãƒ£ãƒ³ãƒã‚¹é«˜</label><div class="flex items-center gap-2 mt-1"><span class="canvas-size-display">... mm</span><button class="btn btn-control" data-style-op="canvas-h-dec">${svgMinus}</button><button class="btn btn-control" data-style-op="canvas-h-inc">${svgPlus}</button></div></div>
                    <div id="global-style-h2-line" class="flex-shrink-0"><label class="form-label">ä¸­è¦‹å‡ºã— è¡Œé–“</label><div class="flex items-center gap-2 mt-1"><span class="line-height-display">... px</span><button class="btn btn-control" data-style-op="h2-line-dec">${svgMinus}</button><button class="btn btn-control" data-style-op="h2-line-inc">${svgPlus}</button></div></div>
                    <div id="global-style-p-line" class="flex-shrink-0"><label class="form-label">å“å è¡Œé–“</label><div class="flex items-center gap-2 mt-1"><span class="line-height-display">... px</span><button class="btn btn-control" data-style-op="p-line-dec">${svgMinus}</button><button class="btn btn-control" data-style-op="p-line-inc">${svgPlus}</button></div></div>
                    <div id="global-style-h2-font" class="flex-shrink-0"><label class="form-label">ä¸­è¦‹å‡ºã—ãƒ•ã‚©ãƒ³ãƒˆ (ä¸€æ‹¬)</label><div class="flex items-center gap-2 mt-1"><span class="line-height-display">... px</span><button class="btn btn-control" data-style-op="all-h2-font-dec">${svgMinus}</button><button class="btn btn-control" data-style-op="all-h2-font-inc">${svgPlus}</button></div></div>
                    <div id="global-style-p-font" class="flex-shrink-0"><label class="form-label">å“åãƒ•ã‚©ãƒ³ãƒˆ (ä¸€æ‹¬)</label><div class="flex items-center gap-2 mt-1"><span class="line-height-display">... px</span><button class="btn btn-control" data-style-op="all-p-font-dec">${svgMinus}</button><button class="btn btn-control" data-style-op="all-p-font-inc">${svgPlus}</button></div></div>
                `;
            }
            
            formTitle.value = menuData.title;
            // (å€¤ã®åæ˜ å‡¦ç†ã¯ä»¥å‰ã¨åŒæ§˜ã®ãŸã‚ã€è¡¨ç¤ºéƒ¨åˆ†ã¯å‰²æ„›ã›ãšå®Ÿè£…)
            const titleFontSizeDisplay = document.querySelector('#title-form-group .font-size-display');
            if (titleFontSizeDisplay) titleFontSizeDisplay.textContent = `${menuData.titleFontSize}px`;
            const formFontFamily = document.getElementById('form-font-family'); 
            if (formFontFamily) formFontFamily.value = menuData.styles.fontFamily; 
            const canvasWDisplay = document.querySelector('#global-style-canvas-w .canvas-size-display');
            if (canvasWDisplay) canvasWDisplay.textContent = menuData.styles.canvasWidth.toFixed(0) + ' mm';
            const canvasHDisplay = document.querySelector('#global-style-canvas-h .canvas-size-display');
            if (canvasHDisplay) canvasHDisplay.textContent = menuData.styles.canvasHeight.toFixed(0) + ' mm';
            const h2LineDisplay = document.querySelector('#global-style-h2-line .line-height-display');
            if (h2LineDisplay) h2LineDisplay.textContent = menuData.styles.lineHeightH2.toFixed(0) + 'px';
            const pLineDisplay = document.querySelector('#global-style-p-line .line-height-display');
            if (pLineDisplay) pLineDisplay.textContent = menuData.styles.lineHeightP.toFixed(0) + 'px';

            let totalH2 = 0; let countH2 = menuData.categories.length;
            const h2FontDisplay = document.querySelector('#global-style-h2-font .line-height-display');
            if (countH2 > 0) { menuData.categories.forEach(cat => totalH2 += cat.fontSizeH2); if (h2FontDisplay) h2FontDisplay.textContent = (totalH2 / countH2).toFixed(0) + ' px'; }
            let totalP = 0; let countP = 0;
            menuData.categories.forEach(cat => { cat.items.forEach(item => { totalP += item.fontSizeP; countP++; }); });
            const pFontDisplay = document.querySelector('#global-style-p-font .line-height-display');
            if (countP > 0) { if (pFontDisplay) pFontDisplay.textContent = (totalP / countP).toFixed(0) + ' px'; }

            categoriesFormList.innerHTML = '';
            menuData.categories.forEach((category) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'border border-gray-300 rounded-lg p-4 mb-4 bg-white';
                categoryDiv.dataset.id = category.id; 
                categoryDiv.innerHTML = `
                    <div class="form-row"><span class="drag-handle cat-handle">:::</span><input type="checkbox" class="form-checkbox" data-cat-id="${category.id}" ${category.isChecked ? 'checked' : ''}><input type="text" class="form-input form-input-grow" data-cat-id="${category.id}" value="${category.name}"><span class="font-size-label">Size:</span><span class="font-size-display">${category.fontSizeH2}px</span><button class="btn btn-control" data-style-op="h2-font-dec" data-cat-id="${category.id}">${svgMinus}</button><button class="btn btn-control" data-style-op="h2-font-inc" data-cat-id="${category.id}">${svgPlus}</button><button class="btn btn-control btn-control-danger" data-delete-cat-id="${category.id}">${svgTrash}</button></div>
                `;
                const itemsListDiv = document.createElement('div');
                itemsListDiv.className = 'mt-4 pt-4 border-t border-gray-200 items-list';
                itemsListDiv.dataset.catId = category.id;
                category.items.forEach((item) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'form-row';
                    itemDiv.dataset.id = item.id;
                    itemDiv.innerHTML = `
                        <span class="drag-handle item-handle ml-4">:::</span><input type="checkbox" class="form-checkbox" data-item-id="${item.id}" ${item.isChecked ? 'checked' : ''}><input type="text" class="form-input form-input-grow" data-item-id="${item.id}" value="${item.name}"><span class="font-size-label">Size:</span><span class="font-size-display">${item.fontSizeP}px</span><button class="btn btn-control" data-style-op="p-font-dec" data-item-id="${item.id}">${svgMinus}</button><button class="btn btn-control" data-style-op="p-font-inc" data-item-id="${item.id}">${svgPlus}</button><button class="btn btn-control btn-control-danger" data-delete-item-id="${item.id}">${svgTrash}</button>
                    `;
                    itemsListDiv.appendChild(itemDiv);
                });
                categoryDiv.appendChild(itemsListDiv);
                const addItemBtn = document.createElement('button');
                addItemBtn.className = 'btn btn-secondary w-full mt-4';
                addItemBtn.textContent = 'ï¼‹ å“åã‚’è¿½åŠ ';
                addItemBtn.dataset.catId = category.id;
                categoryDiv.appendChild(addItemBtn);
                categoriesFormList.appendChild(categoryDiv);
            });
            initSortable();
        }
        
        // === 4. SortableJS ===
        function initSortable() {
            new Sortable(categoriesFormList, { handle: '.cat-handle', animation: 150, ghostClass: 'sortable-ghost', onEnd: (evt) => { const item = menuData.categories.splice(evt.oldIndex, 1)[0]; menuData.categories.splice(evt.newIndex, 0, item); renderAll(); } });
            document.querySelectorAll('.items-list').forEach(list => { new Sortable(list, { handle: '.item-handle', animation: 150, ghostClass: 'sortable-ghost', onEnd: (evt) => { const catId = evt.from.dataset.catId; const category = menuData.categories.find(c => c.id === catId); if (category) { const item = category.items.splice(evt.oldIndex, 1)[0]; category.items.splice(evt.newIndex, 0, item); renderAll(); } } }); });
        }
        function renderAll() { updateCanvasStyle(); renderPreview(); renderForm(); }

        // === 6. PDFå‡ºåŠ› (html-to-image æ¡ç”¨: æœ€æ–°ã®ã‚¹ã‚¯ã‚·ãƒ§æ–¹å¼) ===
        async function handleExportPDF() {
            exportPdfBtn.textContent = 'å‡¦ç†ä¸­...';
            exportPdfBtn.disabled = true;

            try {
                // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾…æ©Ÿ
                await document.fonts.ready;
                
                const element = document.getElementById('canvas');
                
                // ã€html-to-imageã€‘ã‚’ä½¿ç”¨
                // ç”»åƒã¨ã—ã¦DOMã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ (PNGãƒ‡ãƒ¼ã‚¿URLã‚’å–å¾—)
                const dataUrl = await htmlToImage.toPng(element, {
                    quality: 1.0,
                    pixelRatio: 3, // é«˜è§£åƒåº¦ã«ã™ã‚‹ (3å€)
                    cacheBust: true, // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–
                    style: {
                        margin: 0 // ä½™è¨ˆãªä½™ç™½é™¤å»
                    }
                });

                // ã“ã“ã‹ã‚‰ã¯ jsPDF ã§è²¼ã‚Šä»˜ã‘
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                
                const a4Width = 210;
                const a4Height = 297;
                const canvasWidthMM = menuData.styles.canvasWidth;
                const canvasHeightMM = menuData.styles.canvasHeight;
                const marginX = (a4Width / 2 - canvasWidthMM) / 2;
                const marginY = (a4Height - canvasHeightMM) / 2;

                pdf.addImage(dataUrl, 'PNG', marginX, marginY, canvasWidthMM, canvasHeightMM);
                pdf.addImage(dataUrl, 'PNG', a4Width / 2 + marginX, marginY, canvasWidthMM, canvasHeightMM);
                
                pdf.save('ãŠå“æ›¸ã.pdf');

            } catch (error) {
                console.error("PDF Error:", error);
                alert("ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã€Œãƒ–ãƒ©ã‚¦ã‚¶å°åˆ·ã€ãƒœã‚¿ãƒ³ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚");
            } finally {
                exportPdfBtn.textContent = 'ğŸ“¸ ç”»åƒã‚¹ã‚¯ã‚·ãƒ§æ–¹å¼ã§PDFåŒ– (æ¨å¥¨)';
                exportPdfBtn.disabled = false;
            }
        }

        // === 7. ãƒ–ãƒ©ã‚¦ã‚¶å°åˆ·æ©Ÿèƒ½ (äºˆå‚™) ===
        function handleBrowserPrint() {
            window.print();
        }

        // === 8. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ===
        function setupListeners() {
            formContentWrapper.addEventListener('input', (e) => {
                const target = e.target;
                if (target.id === 'form-font-family') { menuData.styles.fontFamily = target.value; updateCanvasStyle(); renderPreview(); return; }
                if (target.id === 'form-title') { menuData.title = target.value; }
                const catId = target.dataset.catId; const itemId = target.dataset.itemId;
                if (catId && !itemId && target.type === 'text') { const category = menuData.categories.find(c => c.id === catId); if (category) category.name = target.value; }
                if (itemId && target.type === 'text') { for (const category of menuData.categories) { const item = category.items.find(i => i.id === itemId); if (item) { item.name = target.value; break; } } }
                if (catId && target.type === 'checkbox') { const category = menuData.categories.find(c => c.id === catId); if (category) category.isChecked = target.checked; }
                if (itemId && target.type === 'checkbox') { for (const category of menuData.categories) { const item = category.items.find(i => i.id === itemId); if (item) { item.isChecked = target.checked; break; } } }
                if (target.type === 'text') { renderPreview(); }
            });
            
            formContentWrapper.addEventListener('click', (e) => {
                const btnDelete = e.target.closest('.btn-control-danger');
                if (btnDelete) {
                    const deleteCatId = btnDelete.dataset.deleteCatId; const deleteItemId = btnDelete.dataset.deleteItemId;
                    if (deleteCatId) { menuData.categories = menuData.categories.filter(c => c.id !== deleteCatId); renderAll(); return; }
                    if (deleteItemId) { menuData.categories.forEach(category => { category.items = category.items.filter(i => i.id !== deleteItemId); }); renderAll(); return; }
                }
                const btnControl = e.target.closest('.btn-control');
                if (btnControl) {
                    const target = btnControl; const catId = target.dataset.catId; const itemId = target.dataset.itemId; const styleOp = target.dataset.styleOp;
                    if (styleOp) {
                        const styles = menuData.styles; let fontSizeChanged = false; let lineHeightChanged = false; let renderAllNeeded = false; let canvasSizeChanged = false; 
                        if (styleOp === 'canvas-w-inc') { styles.canvasWidth = Math.min(105, styles.canvasWidth + 1); canvasSizeChanged = true; }
                        if (styleOp === 'canvas-w-dec') { styles.canvasWidth = Math.max(10, styles.canvasWidth - 1); canvasSizeChanged = true; }
                        if (styleOp === 'canvas-h-inc') { styles.canvasHeight = Math.min(297, styles.canvasHeight + 1); canvasSizeChanged = true; }
                        if (styleOp === 'canvas-h-dec') { styles.canvasHeight = Math.max(50, styles.canvasHeight - 1); canvasSizeChanged = true; }
                        if (canvasSizeChanged) { updateCanvasStyle(); const canvasWDisplay = document.querySelector('#global-style-canvas-w .canvas-size-display'); if (canvasWDisplay) canvasWDisplay.textContent = styles.canvasWidth.toFixed(0) + ' mm'; const canvasHDisplay = document.querySelector('#global-style-canvas-h .canvas-size-display'); if (canvasHDisplay) canvasHDisplay.textContent = styles.canvasHeight.toFixed(0) + ' mm'; }

                        if (styleOp === 'h2-line-inc') { styles.lineHeightH2 += 1; lineHeightChanged = true; }
                        if (styleOp === 'h2-line-dec') { styles.lineHeightH2 = Math.max(8, styles.lineHeightH2 - 1); lineHeightChanged = true; }
                        if (styleOp === 'p-line-inc') { styles.lineHeightP += 1; lineHeightChanged = true; }
                        if (styleOp === 'p-line-dec') { styles.lineHeightP = Math.max(8, styles.lineHeightP - 1); lineHeightChanged = true; }
                        if (lineHeightChanged) { const h2LineDisplay = document.querySelector('#global-style-h2-line .line-height-display'); if (h2LineDisplay) h2LineDisplay.textContent = styles.lineHeightH2.toFixed(0) + 'px'; const pLineDisplay = document.querySelector('#global-style-p-line .line-height-display'); if (pLineDisplay) pLineDisplay.textContent = styles.lineHeightP.toFixed(0) + 'px'; }
                        
                        if (styleOp === 'h1-font-inc') { menuData.titleFontSize += 1; fontSizeChanged = true; const displayEl = target.closest('.form-row').querySelector('.font-size-display'); if (displayEl) displayEl.textContent = `${menuData.titleFontSize}px`; }
                        if (styleOp === 'h1-font-dec') { menuData.titleFontSize = Math.max(8, menuData.titleFontSize - 1); fontSizeChanged = true; const displayEl = target.closest('.form-row').querySelector('.font-size-display'); if (displayEl) displayEl.textContent = `${menuData.titleFontSize}px`; }

                        if (catId && !itemId) { const category = menuData.categories.find(c => c.id === catId); if (category) { if (styleOp === 'h2-font-inc') { category.fontSizeH2 += 1; fontSizeChanged = true; } if (styleOp === 'h2-font-dec') { category.fontSizeH2 = Math.max(8, category.fontSizeH2 - 1); fontSizeChanged = true; } if (fontSizeChanged) { const displayEl = target.closest('.form-row').querySelector('.font-size-display'); if (displayEl) displayEl.textContent = `${category.fontSizeH2}px`; } } }
                        if (itemId) { for (const category of menuData.categories) { const item = category.items.find(i => i.id === itemId); if (item) { if (styleOp === 'p-font-inc') { item.fontSizeP += 1; fontSizeChanged = true; } if (styleOp === 'p-font-dec') { item.fontSizeP = Math.max(8, item.fontSizeP - 1); fontSizeChanged = true; } if (fontSizeChanged) { const displayEl = target.closest('.form-row').querySelector('.font-size-display'); if (displayEl) displayEl.textContent = `${item.fontSizeP}px`; } break; } } }
                        
                        if (styleOp === 'all-h2-font-inc') { menuData.categories.forEach(cat => cat.fontSizeH2 += 1); renderAllNeeded = true; }
                        if (styleOp === 'all-h2-font-dec') { menuData.categories.forEach(cat => cat.fontSizeH2 = Math.max(8, cat.fontSizeH2 - 1)); renderAllNeeded = true; }
                        if (styleOp === 'all-p-font-inc') { menuData.categories.forEach(cat => cat.items.forEach(item => item.fontSizeP += 1)); renderAllNeeded = true; }
                        if (styleOp === 'all-p-font-dec') { menuData.categories.forEach(cat => cat.items.forEach(item => item.fontSizeP = Math.max(8, item.fontSizeP - 1))); renderAllNeeded = true; }

                        if (renderAllNeeded) { renderAll(); } else if (fontSizeChanged || lineHeightChanged) { renderPreview(); }
                    } return; 
                }
                const originalTarget = e.target; if (originalTarget.tagName !== 'BUTTON') return;
                if (originalTarget.id === 'export-pdf-btn' || originalTarget.id === 'browser-print-btn') return;
                
                const catId = originalTarget.dataset.catId;
                if (catId && originalTarget.classList.contains('btn-secondary')) { const category = menuData.categories.find(c => c.id === catId); if (category) { category.items.push({ id: crypto.randomUUID(), name: "æ–°ã—ã„å“å", isChecked: false, fontSizeP: 16 }); renderAll(); } }
                else if (originalTarget.id === 'add-category-btn') { menuData.categories.push({ id: crypto.randomUUID(), name: "æ–°ã—ã„ä¸­è¦‹å‡ºã—", isChecked: false, fontSizeH2: 20, items: [] }); renderAll(); }
                else if (originalTarget.id === 'delete-selected-btn') { menuData.categories.forEach(category => { category.items = category.items.filter(item => !item.isChecked); }); menuData.categories = menuData.categories.filter(category => !category.isChecked); renderAll(); }
            });
            
            exportPdfBtn.addEventListener('click', handleExportPDF);
            browserPrintBtn.addEventListener('click', handleBrowserPrint);
            window.addEventListener('resize', updateCanvasStyle);
        }

        renderAll();
        setupListeners();
    </script>
</body>
</html>
```
